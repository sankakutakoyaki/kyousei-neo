<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <!-- 本体 -->
    <div class="normal-content" th:fragment="bodyFragment">
        <!-- ハンバーガー -->
        <div th:replace="~{fragments/sidebar :: sidebarFragment}"></div>
        <!-- サイドバー -->
        <div class="normal-sidebar" th:insert="~{__${sidebarFragmentName}__}"></div>
        <!-- ボディ -->
        <div class="normal-body">
            <div class="tab-area">
                <ul class="tab-menu">
                    <li class="tab-menu-item is-active" data-tab="01">打刻</li>
                    <li class="tab-menu-item" data-tab="02">修正</li>
                    <li class="tab-menu-item" data-tab="03">出力</li>
                </ul>
                <div class="tab-panel is-show" data-panel="01">
                    <div class="timeworks-container01">
                        <!-- ヘッダー -->
                        <header th:replace="~{fragments/personnel/timeworks :: header01Fragment()}"></header>
                        <div class="table-area">
                            <!-- コンテンツ -->
                            <main
                                th:replace="~{fragments/personnel/timeworks :: mainFragment01('table-01', 'table-01-content')}">
                            </main>
                            <!-- フッター -->
                            <footer id="footer-01" class="pc-style"
                                th:insert="~{fragments/personnel/timeworks :: footerFragment()}"></footer>
                        </div>
                    </div>
                </div>
                <div class="tab-panel" data-panel="02">
                    <div class="timeworks-container02">
                        <!-- サイド -->
                        <div id="timeworks-sidemenu01" class="side-area">
                            <div class="form-parts">
                                <label>営業所・支店</label>
                                <select tabindex="1" name="office" class="normal-select"></select>
                            </div>
                            <ul id="employee-list-01" class="normal-list timeworks"></ul>
                        </div>
                        <!-- メイン -->
                        <div class="main-area">
                            <!-- ヘッダー -->
                            <header th:replace="~{fragments/personnel/timeworks :: header02Fragment()}"></header>
                            <div class="table-area">
                                <!-- コンテンツ -->
                                <main
                                    th:replace="~{fragments/personnel/timeworks :: mainFragment02('table-02', 'table-02-content')}">
                                </main>
                                <!-- フッター -->
                                <footer id="footer-02" class="pc-style"
                                    th:insert="~{fragments/personnel/timeworks :: footerFragment()}"></footer>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-panel" data-panel="03">
                    <div class="timeworks-container03">
                        <!-- <div class="main-area"> -->
                        <div class="form-parts office">
                            <label>営業所・支店</label>
                            <select tabindex="1" name="office" class="normal-select"></select>
                        </div>
                        <!-- ヘッダー -->
                        <header th:replace="~{fragments/personnel/timeworks :: header03Fragment()}"></header>
                        <div class="table-area">
                            <!-- コンテンツ -->
                            <main
                                th:replace="~{fragments/personnel/timeworks :: mainFragment03('table-03', 'table-03-content')}">
                            </main>
                            <!-- フッター -->
                            <footer id="footer-03" class="pc-style"
                                th:insert="~{fragments/personnel/timeworks :: footerFragment()}"></footer>
                        </div>
                        <!-- </div> -->
                    </div>
                </div>
            </div>
        </div>
        <div id="form-dialog-area">
            <!-- フォーム画面をここに記入する -->
        </div>
        <div id="msg-dialog-area">
            <div th:replace="~{fragments/dialog :: messageFragment}"></div>
        </div>
        <!-- </div> -->
        <script th:src="@{/js/table.js}"></script>
        <script th:src="@{/js/info.js}"></script>
        <script th:src="@{/js/timeworks.js}"></script>
        <script th:src="@{/js/enterfocus.js}"></script>
        <script type="text/JavaScript" th:inline="JavaScript">
        const token = /*[[${_csrf.token}]]*/;
        let entity = {};
        const code = document.getElementById('code');
        const name = document.getElementById('name');
        const startBtn = document.querySelector('button[name="start-btn"]');
        const endBtn = document.querySelector('button[name="end-btn"]');
        const officeId = /*[[${officeId}]]*/;
        const officeList = /*[[${officeList}]]*/;
        const employeeList = /*[[${employeeList}]]*/;
        const employeeList01 = document.getElementById('employee-list-01');
        let list02 = {};

// -------------------------------------------------------------------------------------------------------------------------------------- 時計作成
        function clock() {
            // 現在の日時・時刻の情報を取得
            const d = new Date();    
            // 年を取得
            let year = d.getFullYear();
            // 月を取得
            let month = d.getMonth() + 1;
            // 日を取得
            let date = d.getDate();
            // 曜日を取得
            let dayNum = d.getDay();
            const weekday = ["(日)", "(月)", "(火)", "(水)", "(木)", "(金)", "(土)"];
            let day = weekday[dayNum];
            // 時を取得
            let hour = d.getHours();
            // 分を取得
            let min = d.getMinutes();
            // 秒を取得
            let sec = d.getSeconds();

            // 1桁の場合は0を足して2桁に
            month = month < 10 ? "0" + month : month;
            date = date < 10 ? "0" + date : date;
            hour = hour < 10 ? "0" + hour : hour;
            min = min < 10 ? "0" + min : min;
            sec = sec < 10 ? "0" + sec : sec;

            // 日付・時刻の文字列を作成
            let today = `${year}年${month}月${date}日 ${day}`;
            let time = `${hour}:${min}:${sec}`;

            // 文字列を出力
            document.querySelector(".clock-date").innerText = today;
            document.querySelector(".clock-time").innerText = time;
        };

// -------------------------------------------------------------------------------------------------------------------------------------- 更新処理
        async function updateDisplay() {
            startProcessing();

            // リストデータ取得
            const getResponse = await fetch('/timeworks/get/today');
            const list01 = await getResponse.json();
            
            // 画面更新
            await updateTableDisplay("table-01-content", "footer-01", list01);
            
            if (code == null || name == null) return;
            code.value = "";
            name.value = "";
            code.focus();

            processingEnd();
        }

        // テーブルリスト画面を更新する
        function updateTableDisplay(tableId, footerId, list) {
            // リスト画面を初期化
            deleteElements(tableId);
            // リスト作成
            createTableContent(tableId, list);
            // フッター作成
            createTableFooter(footerId, list);
            // テーブルのソートをリセットする
            resetSortable(tableId);
            // テーブルにスクロールバーが表示されたときの処理を登録する
            document.querySelectorAll('.scroll-area').forEach(el => {
                toggleScrollbar(el);
            });
        }

        // コードから[timeworks]を取得して、名前を表示
        async function searchForNameByCode(e) {
            e.preventDefault();
            if (code == null || name == null) return;
            if (code.value == "" || isNaN(code.value)) {
                name.value = "";
                return;
            }

            // [id=code]に入力されたコードから[timeworks]を取得して[id=name]に入力する
            const data = "id=" + encodeURIComponent(parseInt(code.value));
            const url = '/timeworks/get/today/id';
            const contentType = 'application/x-www-form-urlencoded';
            // [timeworks]を取得
            const resultResponse = await postFetch(url, data, token, contentType);
            entity = await resultResponse.json();
            if (entity != null && entity.employee_id > 0) {
                name.value = entity.full_name;
                checkTimeWorksStartSaved(entity);
                return;
            } else {
                code.value = ""
                name.value = "";
                messageDialog("コードが登録されていません", 'エラー', 'red');
                return;
            }
        }

        // コード入力ボックスからフォーカスが外れた時の処理
        function execCodeBlur(e) {
            if (e.target.value == "") {
                name.value = "";
                return;
            }
            searchForNameByCode(e);
        }

        // コード入力ボックスでエンターを押した時の処理
        function execCodeChanged(e) {
            if (e == null) return;
            // ボックスが空白なら処理しない
            if (e.target.value == "") {
                name.value = "";
                return;
            }
            if(e.key === 'Enter'){
                e.preventDefault();
                // searchForNameByCode(e);
                execCodeBlur(e);
            }
        }

// -------------------------------------------------------------------------------------------------------------------------------------- 保存処理
        async function execSave() {
            let changedList = list02.filter(value => (value.state > 0));
            if (changedList.length == 0) return;

            changedList.forEach(function (item) {
                // let target = list02.filter(value => (value.timeworks_id == item.timeworks_id));
                let start = document.querySelector('#table-02-content tr[data-id="' + item.timeworks_id + '"] input[name="start"]');
                let end = document.querySelector('#table-02-content tr[data-id="' + item.timeworks_id + '"] input[name="end"]');
                let rest = document.querySelector('#table-02-content tr[data-id="' + item.timeworks_id + '"] input[name="rest"]');
                item.comp_start_time = start.value;
                item.comp_end_time = end.value;
                item.rest_time = rest.value;
                item.state = 0;
            });
            const result = await updateTimeworks(changedList);
            if (result.success) {
                // 画面更新
                openMsgDialog("msg-dialog", result.message, "blue");
            } else {
                openMsgDialog("msg-dialog", result.message, "red");
            }
        }

// -------------------------------------------------------------------------------------------------------------------------------------- セル変更処理
        function cellChange(id, self) {
            self.classList.add("changed");
            const item = list02.find(value => (value.timeworks_id == Number(id)));
            if (item != null) item.state = 1; // 変更のフラグ
            const btn = document.getElementById("save-btn02");
            if (btn != null) {
                btn.disabled = false;
                if (!btn.classList.contains("ok")){
                    btn.classList.add("ok");
                }
            }
        }

// -------------------------------------------------------------------------------------------------------------------------------------- 出勤退勤確認
        function checkTimeWorksStartSaved(entity) {
            if (entity != null) {
                if (entity.start_time != null) {
                    endBtn.focus();
                } else {
                    startBtn.focus();
                }
            }
        }

// -------------------------------------------------------------------------------------------------------------------------------------- 修正リスト画面作成
        // function createTable(list) {
        function createTableContent(tableId, list) {
            const tbl = document.getElementById(tableId);
            deleteElements(tbl);
            list.forEach(function (item) {
                let newRow = tbl.insertRow();
                // ID（Post送信用）
                newRow.setAttribute('name', 'data-row');
                newRow.setAttribute('data-id', item.timeworks_id);
                // 担当者名
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + item.full_name + '</span></td>');
                // 出勤時刻
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + (item.start_time ?? "") + '</span></td>');
                // 退勤時刻
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + (item.end_time ?? "") + '</span></td>');
                // 営業所
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + (item.office_name ?? "") + '</span></td>');
            });
        };

        // 従業員選択メニュー作成
        function createEmployeeList() {
            employeeList01.innerHTML = "";
            const form01 = document.getElementById('timeworks-sidemenu01');
            const officeArea = form01.querySelector('select[name="office"]');
            const list = employeeList.filter(value => value.office_id === Number(officeArea.value));
            list.forEach(function(item) {
                const li = document.createElement('li');
                li.dataset.id = item.employee_id;
                li.textContent = item.full_name;
                li.addEventListener('click', () => {
                    // すでに選択されているなら解除して return
                    if (li.classList.contains('selected')) {
                        li.classList.remove('selected');
                        return;
                    }
                    // 他のliから選択クラスを外す
                    document.querySelectorAll('#employee-list-01.normal-list>li').forEach(el => el.classList.remove('selected'));
                    // このliに選択クラスを追加
                    li.classList.add('selected');
                    createEmployeeTimeworksList(item.employee_id);
                });
                employeeList01.appendChild(li);
            });
        }

        // 日付ボックスが変更された時の処理
        async function execListChange() {
            const selectedId = document.querySelector("#employee-list-01 li.selected");
            if (selectedId != null) {
                await createEmployeeTimeworksList(selectedId.dataset.id);
            }
        }

        // 選択した従業員IDで勤怠情報を取得してリスト作成
        async function createEmployeeTimeworksList(id) {
            list02 = await getEmployeeTimeworksBetween(id, "start-date01", "end-date01", "/timeworks/get/between/id");
            createBetweenTable02Content(list02);
            // エンターフォーカス処理をイベントリスナーに登録する
            tabFocusElements = createTabFocusElements();
            setEnterFocus("table-02");
        }

        // 修正一覧表示用のテーブル作成
        function createBetweenTable02Content(list) {
            const tbl = document.getElementById("table-02-content");
            deleteElements(tbl);
            let i = 0;
            list.forEach(function (item) {
                let newRow = tbl.insertRow();
                // ID（Post送信用）
                newRow.setAttribute('name', 'data-row');
                newRow.setAttribute('data-id', item.timeworks_id);
                // 担当者名
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + item.work_date + '</span></td>');
                // 出勤打刻
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + (item.start_time ?? "") + '</span></td>');
                // 退勤打刻
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + (item.end_time ?? "") + '</span></td>');
                // 出勤確定
                i++;
                newRow.insertAdjacentHTML('beforeend', '<td><input tabindex="' + i + '" name="start"' +
                    ' class="icon-del" type="time" step="1" value="' + (item.comp_start_time ?? "") + '"' +
                    ' onchange="cellChange(' + item.timeworks_id + ', this)"></td>');
                // 退勤確定
                i++;
                newRow.insertAdjacentHTML('beforeend', '<td><input tabindex="' + i + '" name="end"' +
                    ' class="icon-del" type="time" step="1" value="' + (item.comp_end_time ?? "") + '"' +
                    ' onchange="cellChange(' + item.timeworks_id + ', this)"></td>');
                // 休憩
                i++;
                newRow.insertAdjacentHTML('beforeend', '<td><input tabindex="' + i + '" name="rest"' +
                    ' class="icon-del" type="time" value="' + (item.rest_time ?? "") + '"' +
                    ' onchange="cellChange(' + item.timeworks_id + ', this)"></td>');
            });
            createTableFooter("footer-02", list);
        };

// -------------------------------------------------------------------------------------------------------------------------------------- 取得
        // 一覧表示用のリスト取得
        async function getEmployeeTimeworksBetween(id, startId, endId, url) {
            const start = document.getElementById(startId).value;
            const end = document.getElementById(endId).value;
            const data = "id=" + encodeURIComponent(parseInt(id)) + "&start=" + encodeURIComponent(start) + "&end=" + encodeURIComponent(end);
            const contentType = 'application/x-www-form-urlencoded';
            // List<Timeworks>を取得
            const resultResponse = await postFetch(url, data, token, contentType);
            return await resultResponse.json();
        }

// -------------------------------------------------------------------------------------------------------------------------------------- 出力
        // 選択した営業所IDで従業員の勤怠情報概要を取得してリスト作成
        async function createTimeworksSummaryList(officeId) {
            list03 = await getEmployeeTimeworksBetween(officeId, "start-date02", "end-date02", "/timeworks/summary/get/between/id");
            createBetweenTable03Content(list03);
            // エンターフォーカス処理をイベントリスナーに登録する
            tabFocusElements = createTabFocusElements();
            setEnterFocus("table-03");
        }

        // 出力一覧表示用のテーブル作成
        function createBetweenTable03Content(list) {
            const tbl = document.getElementById("table-03-content");
            deleteElements(tbl);
            let i = 0;
            list.forEach(function (item) {
                let newRow = tbl.insertRow();
                // ID（Post送信用）
                newRow.setAttribute('name', 'data-row');
                newRow.setAttribute('data-id', item.employee_id);
                // チェックセル
                newRow.insertAdjacentHTML('beforeend', '<td name="chk-cell" class="pc-style"><input class="normal-chk" name="chk-box" type="checkbox"></td>');
                // ID
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + item.employee_id + '</span></td>');
                // 担当者名
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + item.full_name + '</span></td>');
                // 総出勤日
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + item.total_working_date + ' 日</span></td>');
                // 総勤務時間
                newRow.insertAdjacentHTML('beforeend', '<td><span>' + item.total_working_time + ' 時間</span></td>');
            });
            createTableFooter("footer-03", list);
        };

// -------------------------------------------------------------------------------------------------------------------------------------- 初期化時の処理
        window.addEventListener("load", async () => {
            // 1秒ごとにclock関数を呼び出す
            setInterval(clock, 1000);
            // コード入力ボックスでエンターキーが押された時の処理を登録
            document.getElementById('code').addEventListener('keydown', function (e) { execCodeChanged(e); });
            // コード入力ボックスのフォーカスが外れた時の処理を登録
            document.getElementById('code').addEventListener('blur', function (e) { execCodeBlur(e); });

            const form01 = document.getElementById('timeworks-sidemenu01');

            const officeArea01 = form01.querySelector('select[name="office"]');
            createComboBox(officeArea01, officeList);
            setComboboxSelected(officeArea01, officeId);
            officeArea01.onchange = function() { createEmployeeList(); };

            const officeArea02 = document.querySelector('div[data-panel="03"] select[name="office"]');
            createComboBoxWithTop(officeArea02, officeList, "すべて");
            setComboboxSelected(officeArea02, officeId);
            officeArea02.onchange = function() { createTimeworksSummaryList(this.value); };

            createEmployeeList();

            // 日付ボックスを設定
            let monthStr = "";
            switch (officeId) {
                case 1000:
                    monthStr = "half-month";
                    break;
                case 1001:
                    monthStr = "half-month";
                    break;
                case 1002:
                    monthStr = "this-month";
                    break;
                case 1003:
                    monthStr = "this-month";
                    break;
                default:
                    monthStr = "this-month"
                    break;
            }
            execSpecifyPeriod(monthStr, 'start-date01', 'end-date01');
            execSpecifyPeriod(monthStr, 'start-date02', 'end-date02');

            await updateDisplay();
            createTimeworksSummaryList(officeId);
            createTableFooter("footer-02", null);
            createTableFooter("footer-03", null);

            // タブメニュー処理
            const tabMenus = document.querySelectorAll('.tab-menu-item');
            // イベント付加
            tabMenus.forEach((tabMenu) => {
                tabMenu.addEventListener('click', tabSwitch);
            })
        });

    </script>
    </div>
</body>

</html>